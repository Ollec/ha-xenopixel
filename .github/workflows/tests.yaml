name: Tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  tests:
    name: Run tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13"]

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install UV
        uses: astral-sh/setup-uv@7eb50e6e20e1e2009087999ba91242e80253875f # v7
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --group dev

      - name: Run tests with coverage
        run: |
          uv run pytest tests/ \
            --cov=src/xenopixel_ble \
            --cov=tools \
            --cov-report=xml \
            --cov-report=term-missing \
            -v

      - name: Upload Python coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: python-coverage
          path: ./coverage.xml

  cpp-tests:
    name: C++ tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake lcov

      - name: Build and run C++ tests
        run: |
          cd tests/cpp
          cmake -B build
          cmake --build build
          ctest --test-dir build --output-on-failure

      - name: Generate C++ coverage
        run: |
          cd tests/cpp
          lcov --capture --directory build --output-file coverage.info \
            --include '*/esphome/components/xenopixel_light/*'

      - name: Upload C++ coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: cpp-coverage
          path: tests/cpp/coverage.info

  coverage-upload:
    name: Upload coverage to Codacy
    needs: [tests, cpp-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Download Python coverage
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: python-coverage

      - name: Download C++ coverage
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: cpp-coverage

      - name: Upload Python coverage (partial)
        run: |
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
            --project-token ${{ secrets.CODACY_PROJECT_TOKEN }} \
            -l Python -r coverage.xml --partial

      - name: Upload C++ coverage (partial)
        run: |
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
            --project-token ${{ secrets.CODACY_PROJECT_TOKEN }} \
            -l CPP -r coverage.info --partial

      - name: Finalize Codacy coverage
        run: |
          bash <(curl -Ls https://coverage.codacy.com/get.sh) final \
            --project-token ${{ secrets.CODACY_PROJECT_TOKEN }}
