# ESPHome configuration for Xenopixel Lightsaber BLE Proxy
# Multi-saber support via packages — each saber gets its own set of entities
#
# Hardware: ESP32 (any variant with BLE support)
# Supports up to 3 simultaneous BLE connections (ESP32 default limit)
#
# Installation:
#   1. Install ESPHome: pip install esphome
#   2. Create secrets.yaml with your credentials and saber MAC addresses
#   3. Compile and upload: esphome run xenopixel_simple.yaml

substitutions:
  device_name: xenopixel-saber
  friendly_name: "Xenopixel"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

external_components:
  - source: components

esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logging
logger:
  level: DEBUG

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

# Enable OTA updates
ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: NONE  # Required for reliable UDP broadcast reception (WLED sync)
  ap:
    ssid: "${device_name} Fallback"
    password: !secret ap_password

# Captive portal for WiFi setup
captive_portal:

web_server:
  port: 80

# Enable Bluetooth
esp32_ble_tracker:
  scan_parameters:
    active: true

# Per-saber packages — each includes all entities for one saber
#
# Single saber:  Comment out the saber2 package AND its WLED dispatch lines below.
# Add a saber:   Add a new package block and a dispatch line in the WLED lambda.
packages:
  saber1: !include
    file: packages/saber.yaml
    vars:
      saber_id: saber1
      saber_name: !secret saber1_name
      saber_mac: !secret saber1_mac
  saber2: !include
    file: packages/saber.yaml
    vars:
      saber_id: saber2
      saber_name: !secret saber2_name
      saber_mac: !secret saber2_mac

# WLED UDP sync — single listener dispatches to all sabers with WLED active
interval:
  - interval: 16ms
    then:
      - lambda: |-
          #include <WiFiUdp.h>
          static WiFiUDP udp;
          static bool started = false;
          if (!started) {
            if (!wifi::global_wifi_component || !wifi::global_wifi_component->is_connected()) return;
            udp.begin(21324);
            started = true;
            ESP_LOGI("xenopixel", "WLED UDP listener started on port 21324");
          }
          uint8_t buf[256];
          int latest_len = 0;
          int pkt_size;
          while ((pkt_size = udp.parsePacket()) > 0) {
            if (pkt_size >= 6) latest_len = udp.read(buf, sizeof(buf));
            udp.clear();
          }
          if (latest_len < 6) return;
          std::vector<uint8_t> data(buf, buf + latest_len);
          // --- WLED dispatch: one line per saber ---
          // Comment out a saber's lines here when removing its package above.
          auto *s1 = (xenopixel_light::XenopixelLight *)id(saber1_light).get_output();
          if (s1->is_wled_active()) s1->apply_wled_packet(data);
          auto *s2 = (xenopixel_light::XenopixelLight *)id(saber2_light).get_output();
          if (s2->is_wled_active()) s2->apply_wled_packet(data);
